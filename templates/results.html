<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimization Results - MILP Agent</title>
    <link rel="stylesheet" href="../static/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-robot"></i>
                <span>MILP Agent</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="index.html#features" class="nav-link">Features</a>
                <a href="index.html#about" class="nav-link">About</a>
            </div>
        </div>
    </nav>

    <!-- Results Header -->
    <section class="results-header">
        <div class="container">
            <div class="results-title" data-aos="fade-up">
                <h1>Optimization Results</h1>
                <p class="results-subtitle" id="resultsSubtitle">Run an optimization to see results</p>
                <div class="status-badge" id="statusBadge" style="display:none;">
                    <i class="fas fa-check-circle"></i>
                    <span id="statusBadgeText">Optimization Complete</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Problem Summary -->
    <section class="problem-summary">
        <div class="container">
            <div class="summary-card" data-aos="fade-up" data-aos-delay="100">
                <h2><i class="fas fa-clipboard-list"></i> Problem Summary</h2>
                <div class="summary-content" id="problemSummary">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- Placeholder if no results yet -->
    <section class="results-grid" id="resultsPlaceholder">
        <div class="container">
            <div class="summary-card" data-aos="fade-up" data-aos-delay="100">
                <h2><i class="fas fa-info-circle"></i> No Results Yet</h2>
                <p style="color: var(--text-secondary);">
                    Run an optimization first from the homepage to view results here. Once a problem is submitted, this page will display the status, metrics, variables, plan, explanation, constraints, timeline, and code.
                </p>
                <div style="margin-top:1rem;">
                    <a class="btn btn-primary" href="index.html#query"><i class="fas fa-rocket"></i> Go to Optimizer</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Results Grid -->
    <section class="results-grid">
        <div class="container">
            <div class="results-layout" id="resultsContent" style="display:none;">
                <!-- Solution Box -->
                <div class="result-box solution-box" data-aos="fade-up" data-aos-delay="200">
                    <div class="box-header">
                        <h3><i class="fas fa-trophy"></i> Optimal Solution</h3>
                        <div class="box-status" id="optimizationStatusBadge">
                            <i class="fas fa-check" id="optimizationStatusIcon"></i>
                            <span id="optimizationStatus">--</span>
                        </div>
                    </div>
                    <div class="box-content">
                        <div class="solution-metrics">
                            <div class="metric">
                                <span class="metric-label">Objective Value</span>
                                <span class="metric-value" id="objectiveValue">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Solver Time</span>
                                <span class="metric-value" id="solverTime">--</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Iterations</span>
                                <span class="metric-value" id="iterations">--</span>
                            </div>
                        </div>
                        <div class="solution-variables">
                            <h4>Decision Variables</h4>
                            <div class="variables-list" id="variablesList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            <h4 style="margin-top:1rem;">Resource Variables</h4>
                            <div class="variables-list" id="resourcesList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plan Box -->
                <div class="result-box plan-box" data-aos="fade-up" data-aos-delay="300">
                    <div class="box-header">
                        <h3><i class="fas fa-project-diagram"></i> Execution Plan</h3>
                        <div class="box-status info">
                            <i class="fas fa-info-circle"></i>
                            <span>Ready</span>
                        </div>
                    </div>
                    <div class="box-content">
                        <div class="plan-steps" id="planSteps">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="plan-timeline">
                            <h4>Implementation Timeline</h4>
                            <div class="timeline" id="timeline">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Explanation Box -->
                <div class="result-box explanation-box" data-aos="fade-up" data-aos-delay="400">
                    <div class="box-header">
                        <h3><i class="fas fa-lightbulb"></i> Solution Explanation</h3>
                        <div class="box-status warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Analysis</span>
                        </div>
                    </div>
                    <div class="box-content">
                        <div class="explanation-content" id="explanationContent">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="constraints-analysis">
                            <h4>Constraint Analysis</h4>
                            <div class="constraints-list" id="constraintsList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Box (toggle) -->
                <div class="result-box code-box" data-aos="fade-up" data-aos-delay="500">
                    <div class="box-header">
                        <h3><i class="fas fa-code"></i> Interactive Code Explorer</h3>
                        <div class="box-actions">
                            <button class="btn btn-small" onclick="copyCode()">
                                <i class="fas fa-copy"></i>
                                Copy
                            </button>
                            <button class="btn btn-small" onclick="downloadCode()">
                                <i class="fas fa-download"></i>
                                Download
                            </button>
                            <button class="btn btn-small" onclick="runCode()">
                                <i class="fas fa-play"></i>
                                Run
                            </button>
                        </div>
                    </div>
                    <div class="box-content">
                        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:8px;">
                            <input type="checkbox" id="toggleCodeExplorer" checked onchange="toggleCodeExplorerVisibility()">
                            <label for="toggleCodeExplorer" style="color:var(--text-secondary);">Show Code Explorer</label>
                        </div>
                        <div class="code-tabs">
                            <button class="tab-btn active" onclick="switchTab('python')">
                                <i class="fab fa-python"></i> Python
                            </button>
                            <button class="tab-btn" onclick="switchTab('matlab')">
                                <i class="fas fa-calculator"></i> MATLAB
                            </button>
                            <button class="tab-btn" onclick="switchTab('r')">
                                <i class="fas fa-chart-line"></i> R
                            </button>
                        </div>
                        
                        <!-- Code Explanation Panel -->
                        <div class="code-explanation">
                            <div class="explanation-header">
                                <h4><i class="fas fa-lightbulb"></i> Code Walkthrough</h4>
                                <button class="btn btn-tiny" onclick="toggleExplanation()">
                                    <i class="fas fa-eye"></i>
                                    <span id="explanationToggle">Hide</span>
                                </button>
                            </div>
                            <div class="explanation-content" id="codeExplanation">
                                <div class="explanation-step active" data-step="1">
                                    <div class="step-indicator">1</div>
                                    <div class="step-content">
                                        <h5>Import Libraries</h5>
                                        <p>Import PuLP for optimization, NumPy for numerical operations, and Pandas for data handling.</p>
                                    </div>
                                </div>
                                <div class="explanation-step" data-step="2">
                                    <div class="step-indicator">2</div>
                                    <div class="step-content">
                                        <h5>Define Problem</h5>
                                        <p>Create a maximization problem instance for production optimization.</p>
                                    </div>
                                </div>
                                <div class="explanation-step" data-step="3">
                                    <div class="step-indicator">3</div>
                                    <div class="step-content">
                                        <h5>Decision Variables</h5>
                                        <p>Define integer variables for products and continuous variables for resources.</p>
                                    </div>
                                </div>
                                <div class="explanation-step" data-step="4">
                                    <div class="step-indicator">4</div>
                                    <div class="step-content">
                                        <h5>Objective Function</h5>
                                        <p>Set up the profit maximization objective with product revenues and resource costs.</p>
                                    </div>
                                </div>
                                <div class="explanation-step" data-step="5">
                                    <div class="step-indicator">5</div>
                                    <div class="step-content">
                                        <h5>Constraints</h5>
                                        <p>Add production capacity, labor hours, minimum production, and resource constraints.</p>
                                    </div>
                                </div>
                                <div class="explanation-step" data-step="6">
                                    <div class="step-indicator">6</div>
                                    <div class="step-content">
                                        <h5>Solve & Results</h5>
                                        <p>Execute the optimization and display the optimal solution and variable values.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="code-content">
                            <div class="code-line-numbers">
                                <div class="line-numbers" id="lineNumbers">
                                    <!-- Generated by JavaScript -->
                                </div>
                            </div>
                            <div class="code-editor">
                                <pre><code class="language-python" id="pythonCode">
# MILP Optimization Solution
import pulp
import numpy as np
import pandas as pd

# Problem setup
prob = pulp.LpProblem("Production_Optimization", pulp.LpMaximize)

# Decision variables
x = pulp.LpVariable.dicts("product", range(3), lowBound=0, cat='Integer')
y = pulp.LpVariable.dicts("resource", range(2), lowBound=0, cat='Continuous')

# Objective function
prob += 100*x[0] + 150*x[1] + 200*x[2] - 50*y[0] - 75*y[1]

# Constraints
prob += x[0] + x[1] + x[2] <= 1000  # Production capacity
prob += 2*x[0] + 3*x[1] + 4*x[2] <= 3000  # Labor hours
prob += x[0] >= 50  # Minimum production
prob += y[0] + y[1] <= 500  # Resource limit

# Solve
prob.solve()

# Results
print(f"Status: {pulp.LpStatus[prob.status]}")
print(f"Objective Value: ${pulp.value(prob.objective):,.2f}")
for i in range(3):
    print(f"Product {i+1}: {x[i].varValue:.0f} units")
                                </code></pre>
                                <pre><code class="language-matlab" id="matlabCode" style="display: none;">
% MILP Optimization Solution
% Using MATLAB Optimization Toolbox

% Problem setup
f = [-100; -150; -200; 50; 75];  % Objective coefficients
intcon = [1; 2; 3];  % Integer variables
A = [1 1 1 0 0; 2 3 4 0 0; 0 0 0 1 1];
b = [1000; 3000; 500];
Aeq = [];
beq = [];
lb = [50; 0; 0; 0; 0];
ub = [inf; inf; inf; inf; inf];

% Solve
[x, fval, exitflag] = intlinprog(f, intcon, A, b, Aeq, beq, lb, ub);

% Display results
fprintf('Status: %d\n', exitflag);
fprintf('Objective Value: $%.2f\n', -fval);
for i = 1:3
    fprintf('Product %d: %.0f units\n', i, x(i));
end
                                </code></pre>
                                <pre><code class="language-r" id="rCode" style="display: none;">
# MILP Optimization Solution
# Using R optimization packages

library(lpSolve)

# Problem setup
objective <- c(100, 150, 200, -50, -75)
const.mat <- matrix(c(1,1,1,0,0,
                     2,3,4,0,0,
                     0,0,0,1,1), nrow=3, byrow=TRUE)
const.dir <- c("<=", "<=", "<=")
const.rhs <- c(1000, 3000, 500)
int.vec <- c(1, 2, 3)  # Integer variables

# Solve
result <- lp("max", objective, const.mat, const.dir, const.rhs, 
             int.vec = int.vec)

# Display results
cat("Status:", result$status, "\n")
cat("Objective Value: $", result$objval, "\n")
for(i in 1:3) {
    cat("Product", i, ":", result$solution[i], "units\n")
}
                                </code></pre>
                            </div>
                        </div>
                        
                        <!-- Code Output Panel -->
                        <div class="code-output" id="codeOutput" style="display: none;">
                            <div class="output-header">
                                <h4><i class="fas fa-terminal"></i> Execution Output</h4>
                                <button class="btn btn-tiny" onclick="clearOutput()">
                                    <i class="fas fa-trash"></i>
                                    Clear
                                </button>
                            </div>
                            <div class="output-content" id="outputContent">
                                <!-- Output will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Action Buttons -->
    <section class="action-buttons">
        <div class="container">
            <div class="button-group" data-aos="fade-up">
                <button class="btn btn-primary btn-large" onclick="runNewOptimization()">
                    <i class="fas fa-plus"></i>
                    New Optimization
                </button>
                <button class="btn btn-secondary btn-large" onclick="exportResults()">
                    <i class="fas fa-file-export"></i>
                    Export Results
                </button>
                <button class="btn btn-secondary btn-large" onclick="shareResults()">
                    <i class="fas fa-share"></i>
                    Share Results
                </button>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>MILP Agent</h3>
                    <p>Advanced optimization solutions powered by artificial intelligence.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="index.html#features">Features</a></li>
                        <li><a href="index.html#about">About</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>support@milpagent.com</p>
                    <p>+1 (555) 123-4567</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 MILP Optimization Agent. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script>
        // API Configuration
        window.API_CONFIG = {
            baseURL: window.location.origin, // Use same origin as the frontend
            endpoints: {
                solver: '/solver/solve',
                planner: '/planner/plan',
                explainer: '/explainer/solve',
                code: '/solver/code'
            }
        };
    </script>
    <script src="static/script.js"></script>
    <script>
        // Results page specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init({
                duration: 1000,
                once: true,
                offset: 100
            });
            
            loadOptimizationData();
        });

        function loadOptimizationData() {
            const data = localStorage.getItem('optimizationData');
            const apiData = localStorage.getItem('apiResults');
            const errorData = localStorage.getItem('apiError');
            
            if (data) {
                const optimizationData = JSON.parse(data);
                displayProblemSummary(optimizationData);
            }
            
            // Show error notification if API failed
            if (errorData) {
                const error = JSON.parse(errorData);
                showErrorNotification(error.message);
            }
            
            if (apiData) {
                const apiResults = JSON.parse(apiData);
                generateResultsFromAPI(apiResults);
            } else {
                // Fallback to mock data if API results not available
                console.log('No API results found, showing placeholder');
                showPlaceholder();
            }
        }

        function showErrorNotification(errorMessage) {
            // Create error notification
            const notification = document.createElement('div');
            notification.className = 'error-notification';
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>API Error: ${errorMessage}</span>
                    <button onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        function displayProblemSummary(data) {
            const summaryElement = document.getElementById('problemSummary');
            summaryElement.innerHTML = `
                <div class="summary-item">
                    <strong>Description:</strong> ${data.problemDescription}
                </div>
                ${data.constraints ? `<div class="summary-item"><strong>Constraints:</strong> ${data.constraints}</div>` : ''}
            `;
        }

        function generateResultsFromAPI(apiResults) {
            try {
                // Use solver results for solution data
                const solverOutput = apiResults.solver.output || apiResults.solver;
                const plannerOutput = apiResults.planner;
                const explainerOutput = apiResults.explainer;
                
                // Extract variables from solver output
                const variables = extractVariablesFromSolver(solverOutput);
                
                // Use planner results for plan steps
                const planSteps = extractPlanSteps(plannerOutput);
                
                // Use explainer results for explanation
                const explanation = extractExplanation(explainerOutput);
                
                // Generate timeline from planner
                const timeline = generateTimelineFromPlanner(plannerOutput);
                
                // Extract constraints from solver
                const constraints = extractConstraintsFromSolver(solverOutput);
                
                // Populate the results
                populateVariables(variables);
                populatePlanSteps(planSteps);
                populateTimeline(timeline);
                populateExplanation(explanation);
                populateConstraints(constraints);
                setOptimizationMetricsFromText(solverOutput);
                showResults();
                
                // Update code with generated code from API
                updateCodeFromAPI();
                
            } catch (error) {
                console.error('Error processing API results:', error);
                showPlaceholder();
            }
        }

        function extractVariablesFromSolver(solverOutput) {
            // Parse solver output to extract variables
            if (typeof solverOutput === 'string') {
                // Try to parse JSON or extract variables from text
                try {
                    const parsed = JSON.parse(solverOutput);
                    return Object.entries(parsed).map(([name, value]) => ({
                        name: name,
                        value: value,
                        unit: 'units'
                    }));
                } catch {
                    // Extract variables from text output
                    const lines = solverOutput.split('\n');
                    const variables = [];
                    lines.forEach(line => {
                        const match = line.match(/(\w+)\s*[:=]\s*([\d.]+)/);
                        if (match) {
                            variables.push({
                                name: match[1],
                                value: parseFloat(match[2]),
                                unit: 'units'
                            });
                        }
                    });
                    return variables;
                }
            }
            return [];
        }

        function extractPlanSteps(plannerOutput) {
            if (typeof plannerOutput === 'string') {
                return plannerOutput.split('\n').filter(step => step.trim().length > 0);
            }
            return [
                'Initialize optimization model with decision variables',
                'Define objective function and constraints',
                'Apply branch-and-bound algorithm',
                'Solve linear programming relaxation',
                'Generate optimal solution',
                'Validate solution feasibility',
                'Export results and implementation code'
            ];
        }

        function extractExplanation(explainerOutput) {
            if (typeof explainerOutput === 'string') {
                return `<p>${explainerOutput}</p>`;
            }
            return `
                <p>The optimal solution maximizes profit while satisfying all production constraints. 
                The algorithm found the optimal solution through advanced MILP techniques.</p>
                <p>Key insights from the solution:</p>
                <ul>
                    <li>Solution found using state-of-the-art optimization algorithms</li>
                    <li>All constraints satisfied with optimal objective value</li>
                    <li>Implementation ready for production deployment</li>
                </ul>
            `;
        }

        function generateTimelineFromPlanner(plannerOutput) {
            return [
                { phase: 'Model Setup', duration: '2 min', status: 'completed' },
                { phase: 'Optimization', duration: '1.5 min', status: 'completed' },
                { phase: 'Validation', duration: '1 min', status: 'completed' },
                { phase: 'Code Generation', duration: '0.5 min', status: 'completed' }
            ];
        }

        function extractConstraintsFromSolver(solverOutput) {
            return [
                { name: 'Primary Constraints', status: 'binding', slack: 0 },
                { name: 'Resource Limits', status: 'binding', slack: 0 },
                { name: 'Capacity Constraints', status: 'non-binding', slack: 50 },
                { name: 'Quality Requirements', status: 'binding', slack: 0 }
            ];
        }

        async function updateCodeFromAPI() {
            try {
                const apiConfig = window.API_CONFIG || {
                    baseURL: window.location.origin,
                    endpoints: { code: '/solver/code' }
                };
                
                const response = await fetch(`${apiConfig.baseURL}${apiConfig.endpoints.code}`);
                const data = await response.json();
                
                if (data.code) {
                    // Update Python code with generated code
                    const pythonCode = document.getElementById('pythonCode');
                    if (pythonCode) {
                        pythonCode.textContent = data.code;
                    }
                }
            } catch (error) {
                console.error('Error fetching generated code:', error);
            }
        }

        // UI helpers
        function showResults() {
            const content = document.getElementById('resultsContent');
            const placeholder = document.getElementById('resultsPlaceholder');
            if (placeholder) placeholder.style.display = 'none';
            if (content) content.style.display = 'grid';
            document.getElementById('resultsSubtitle').textContent = 'Your MILP problem has been processed';
            const badge = document.getElementById('statusBadge');
            if (badge) badge.style.display = 'inline-flex';
        }

        function showPlaceholder() {
            const content = document.getElementById('resultsContent');
            const placeholder = document.getElementById('resultsPlaceholder');
            if (content) content.style.display = 'none';
            if (placeholder) placeholder.style.display = 'block';
            const badge = document.getElementById('statusBadge');
            if (badge) badge.style.display = 'none';
        }

        function setOptimizationMetricsFromText(text) {
            // Try to parse common fields from solver textual output
            if (typeof text !== 'string') return;
            const statusMatch = text.match(/Status\s*[:=]\s*(\w+)/i);
            const objectiveMatch = text.match(/Objective\s*Value\s*[:=]\s*\$?([\d,\.]+)/i);
            const timeMatch = text.match(/Time\s*[:=]\s*([\d\.]+\s*s?)/i);
            const iterMatch = text.match(/Iterations?\s*[:=]\s*([\d,]+)/i);

            const status = statusMatch ? statusMatch[1] : 'Optimal';
            const objective = objectiveMatch ? `$${objectiveMatch[1]}` : '--';
            const time = timeMatch ? timeMatch[1] : '--';
            const iters = iterMatch ? iterMatch[1] : '--';

            setMetrics(status, objective, time, iters);
        }

        function setMetrics(status, objectiveValue, solverTime, iterations) {
            const statusEl = document.getElementById('optimizationStatus');
            const statusBadge = document.getElementById('optimizationStatusBadge');
            const statusIcon = document.getElementById('optimizationStatusIcon');
            if (statusEl && statusBadge) {
                statusEl.textContent = status || '--';
                statusBadge.classList.remove('success','info','warning');
                if ((status || '').toLowerCase().includes('optimal')) {
                    statusBadge.classList.add('success');
                    statusIcon.className = 'fas fa-check';
                    document.getElementById('statusBadgeText').textContent = 'Optimization Complete';
                } else if ((status || '').toLowerCase().includes('feasible')) {
                    statusBadge.classList.add('info');
                    statusIcon.className = 'fas fa-info-circle';
                    document.getElementById('statusBadgeText').textContent = 'Feasible Solution';
                } else {
                    statusBadge.classList.add('warning');
                    statusIcon.className = 'fas fa-exclamation-triangle';
                    document.getElementById('statusBadgeText').textContent = 'Status: ' + status;
                }
            }

            const objEl = document.getElementById('objectiveValue');
            const timeEl = document.getElementById('solverTime');
            const iterEl = document.getElementById('iterations');
            if (objEl) objEl.textContent = objectiveValue || '--';
            if (timeEl) timeEl.textContent = solverTime || '--';
            if (iterEl) iterEl.textContent = iterations || '--';
        }

        function toggleCodeExplorerVisibility() {
            const checkbox = document.getElementById('toggleCodeExplorer');
            const codeArea = document.querySelector('.code-content');
            if (checkbox && codeArea) {
                codeArea.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        function generateResults() {
            // Generate sample results data (fallback)
            const variables = [
                { name: 'x₁ (Product A)', value: 450, unit: 'units' },
                { name: 'x₂ (Product B)', value: 300, unit: 'units' },
                { name: 'x₃ (Product C)', value: 250, unit: 'units' },
                { name: 'y₁ (Resource 1)', value: 200, unit: 'hours' },
                { name: 'y₂ (Resource 2)', value: 300, unit: 'hours' }
            ];

            const planSteps = [
                'Initialize optimization model with decision variables',
                'Define objective function and constraints',
                'Apply branch-and-bound algorithm',
                'Solve linear programming relaxation',
                'Generate optimal solution',
                'Validate solution feasibility',
                'Export results and implementation code'
            ];

            const timeline = [
                { phase: 'Model Setup', duration: '5 min', status: 'completed' },
                { phase: 'Optimization', duration: '1.2 min', status: 'completed' },
                { phase: 'Validation', duration: '2 min', status: 'completed' },
                { phase: 'Code Generation', duration: '1 min', status: 'completed' }
            ];

            const explanation = `
                <p>The optimal solution maximizes profit while satisfying all production constraints. 
                The algorithm found that producing 450 units of Product A, 300 units of Product B, 
                and 250 units of Product C yields the maximum profit of $2,450,000.</p>
                <p>Key insights from the solution:</p>
                <ul>
                    <li>Product A has the highest profit margin and should be prioritized</li>
                    <li>Resource constraints are binding, limiting total production</li>
                    <li>The solution is integer-feasible, making it immediately implementable</li>
                </ul>
            `;

            const constraints = [
                { name: 'Production Capacity', status: 'binding', slack: 0 },
                { name: 'Labor Hours', status: 'binding', slack: 0 },
                { name: 'Resource Limit', status: 'non-binding', slack: 150 },
                { name: 'Minimum Production', status: 'binding', slack: 0 }
            ];

            // Populate the results
            populateVariables(variables);
            populatePlanSteps(planSteps);
            populateTimeline(timeline);
            populateExplanation(explanation);
            populateConstraints(constraints);
            setMetrics('Optimal', '$2,450,000', '1.23s', '847');
            showResults();
        }

        function populateVariables(variables) {
            const decContainer = document.getElementById('variablesList');
            const resContainer = document.getElementById('resourcesList');
            const decision = [];
            const resources = [];
            variables.forEach(v => {
                const name = (v.name || '').toLowerCase();
                if (name.startsWith('y')) {
                    resources.push(v);
                } else {
                    decision.push(v);
                }
            });
            const toHtml = (v) => `
                <div class="variable-item">
                    <span class="variable-name">${v.name}</span>
                    <span class="variable-value">${v.value} ${v.unit || ''}</span>
                </div>`;
            if (decContainer) decContainer.innerHTML = decision.map(toHtml).join('');
            if (resContainer) resContainer.innerHTML = resources.map(toHtml).join('');
        }

        function populatePlanSteps(steps) {
            const container = document.getElementById('planSteps');
            container.innerHTML = steps.map((step, index) => `
                <div class="plan-step">
                    <div class="step-number">${index + 1}</div>
                    <div class="step-content">${step}</div>
                </div>
            `).join('');
        }

        function populateTimeline(timeline) {
            const container = document.getElementById('timeline');
            container.innerHTML = timeline.map(item => `
                <div class="timeline-item">
                    <div class="timeline-phase">${item.phase}</div>
                    <div class="timeline-duration">${item.duration}</div>
                    <div class="timeline-status ${item.status}">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
            `).join('');
        }

        function populateExplanation(explanation) {
            document.getElementById('explanationContent').innerHTML = explanation;
        }

        function populateConstraints(constraints) {
            const container = document.getElementById('constraintsList');
            container.innerHTML = constraints.map(c => `
                <div class="constraint-item">
                    <span class="constraint-name">${c.name}</span>
                    <span class="constraint-status ${c.status}">${c.status}</span>
                    <span class="constraint-slack">Slack: ${c.slack}</span>
                </div>
            `).join('');
        }

        function switchTab(language) {
            // Hide all code blocks
            document.querySelectorAll('.code-content pre').forEach(block => {
                block.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected code block
            document.getElementById(language + 'Code').style.display = 'block';
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        function copyCode() {
            const activeCode = document.querySelector('.code-content pre[style*="block"] code');
            navigator.clipboard.writeText(activeCode.textContent);
            
            // Show feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        function downloadCode() {
            const activeCode = document.querySelector('.code-content pre[style*="block"] code');
            const blob = new Blob([activeCode.textContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'milp_solution.py';
            a.click();
            URL.revokeObjectURL(url);
        }

        function runNewOptimization() {
            window.location.href = 'index.html#query';
        }

        function exportResults() {
            // Create a comprehensive report
            const report = {
                timestamp: new Date().toISOString(),
                problem: JSON.parse(localStorage.getItem('optimizationData')),
                results: {
                    objectiveValue: '$2,450,000',
                    solverTime: '1.23s',
                    iterations: 847
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'optimization_results.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function shareResults() {
            if (navigator.share) {
                navigator.share({
                    title: 'MILP Optimization Results',
                    text: 'Check out my optimization results from MILP Agent!',
                    url: window.location.href
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(window.location.href);
                alert('Results link copied to clipboard!');
            }
        }

        // Enhanced Code Explorer Functions
        async function runCode() {
            const outputPanel = document.getElementById('codeOutput');
            const outputContent = document.getElementById('outputContent');
            const runButton = event.target;
            const originalText = runButton.innerHTML;
            
            // Show loading state
            runButton.innerHTML = '<div class="loading"></div> Running...';
            runButton.disabled = true;
            
            // Show output panel
            outputPanel.style.display = 'block';
            outputContent.innerHTML = '<div class="loading-output">Executing code...</div>';
            
            try {
                // Get the problem description from localStorage
                const optimizationData = JSON.parse(localStorage.getItem('optimizationData') || '{}');
                const problemDescription = optimizationData.problemDescription || 'Default optimization problem';
                
                // Call the solver API to get real results
                const apiConfig = window.API_CONFIG || {
                    baseURL: window.location.origin,
                    endpoints: { solver: '/solver/solve' }
                };
                
                const response = await fetch(`${apiConfig.baseURL}${apiConfig.endpoints.solver}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ problem_description: problemDescription })
                });
                
                const result = await response.json();
                const solverOutput = result.output || result;
                
                // Display the real API output
                let output = '';
                if (typeof solverOutput === 'string') {
                    // Parse string output
                    const lines = solverOutput.split('\n');
                    lines.forEach(line => {
                        if (line.trim()) {
                            if (line.includes('Status') || line.includes('Optimal')) {
                                output += `<div class="output-line success">${line}</div>`;
                            } else if (line.includes('Value') || line.includes('Objective')) {
                                output += `<div class="output-line info">${line}</div>`;
                            } else {
                                output += `<div class="output-line">${line}</div>`;
                            }
                        }
                    });
                } else {
                    // Parse JSON output
                    Object.entries(solverOutput).forEach(([key, value]) => {
                        output += `<div class="output-line">${key}: ${value}</div>`;
                    });
                }
                
                output += '<div class="output-line success">✓ Optimization completed successfully!</div>';
                outputContent.innerHTML = output;
                
            } catch (error) {
                console.error('Error running code:', error);
                outputContent.innerHTML = `
                    <div class="output-line error">Error: ${error.message}</div>
                    <div class="output-line error">Please check your API connection</div>
                `;
            }
            
            runButton.innerHTML = originalText;
            runButton.disabled = false;
        }

        function toggleExplanation() {
            const explanation = document.getElementById('codeExplanation');
            const toggle = document.getElementById('explanationToggle');
            
            if (explanation.style.display === 'none') {
                explanation.style.display = 'block';
                toggle.textContent = 'Hide';
            } else {
                explanation.style.display = 'none';
                toggle.textContent = 'Show';
            }
        }

        function clearOutput() {
            const outputContent = document.getElementById('outputContent');
            outputContent.innerHTML = '';
        }

        // Interactive code explanation
        function highlightCodeStep(stepNumber) {
            const steps = document.querySelectorAll('.explanation-step');
            const codeLines = document.querySelectorAll('.code-editor pre code');
            
            // Remove active class from all steps
            steps.forEach(step => step.classList.remove('active'));
            
            // Add active class to current step
            const currentStep = document.querySelector(`[data-step="${stepNumber}"]`);
            if (currentStep) {
                currentStep.classList.add('active');
            }
            
            // Highlight corresponding code lines (simplified)
            const activeCode = document.querySelector('.code-content pre[style*="block"] code');
            if (activeCode) {
                // Add visual feedback for code sections
                activeCode.style.background = 'rgba(99, 102, 241, 0.1)';
                setTimeout(() => {
                    activeCode.style.background = '';
                }, 1000);
            }
        }

        // Auto-generate line numbers
        function generateLineNumbers() {
            const activeCode = document.querySelector('.code-content pre[style*="block"] code');
            if (activeCode) {
                const lines = activeCode.textContent.split('\n').length;
                const lineNumbers = document.getElementById('lineNumbers');
                lineNumbers.innerHTML = Array.from({length: lines}, (_, i) => `<div class="line-number">${i + 1}</div>`).join('');
            }
        }

        // Enhanced tab switching with animations
        function switchTab(language) {
            // Hide all code blocks with animation
            document.querySelectorAll('.code-content pre').forEach(block => {
                block.style.opacity = '0';
                block.style.transform = 'translateX(20px)';
                setTimeout(() => {
                    block.style.display = 'none';
                }, 300);
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected code block with animation
            setTimeout(() => {
                const selectedCode = document.getElementById(language + 'Code');
                selectedCode.style.display = 'block';
                selectedCode.style.opacity = '0';
                selectedCode.style.transform = 'translateX(20px)';
                
                setTimeout(() => {
                    selectedCode.style.opacity = '1';
                    selectedCode.style.transform = 'translateX(0)';
                }, 50);
            }, 300);
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            // Regenerate line numbers for new code
            setTimeout(() => {
                generateLineNumbers();
            }, 400);
        }

        // Initialize interactive features
        document.addEventListener('DOMContentLoaded', function() {
            // Generate initial line numbers
            setTimeout(generateLineNumbers, 1000);
            
            // Add click handlers to explanation steps
            document.querySelectorAll('.explanation-step').forEach((step, index) => {
                step.addEventListener('click', () => {
                    highlightCodeStep(index + 1);
                });
            });
            
            // Auto-advance explanation steps
            let currentStep = 1;
            setInterval(() => {
                if (currentStep <= 6) {
                    highlightCodeStep(currentStep);
                    currentStep++;
                } else {
                    currentStep = 1;
                }
            }, 3000);
        });
    </script>
</body>
</html>
